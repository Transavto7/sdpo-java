{"version":3,"file":"js/95.ba6c09ed.js","mappings":"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","sources":["webpack://sdpo-frontend/./src/helpers/camera.js","webpack://sdpo-frontend/./src/helpers/media.js","webpack://sdpo-frontend/./src/pages/inspection/Step-alcometer.vue","webpack://sdpo-frontend/./src/pages/inspection/Step-alcometer.vue?12cd"],"sourcesContent":["import {defaultError} from \"@/helpers/http-errors\";\nimport {startWaitTimerRecordMedia} from \"@/helpers/media\";\nimport store from \"@/store\";\n\nexport async function makePhoto() {\n    return await axios.post(`device/photo`).then(({ data }) => {\n        return data;\n    }).catch(defaultError);\n}\n\nexport async function getSizes() {\n    return await axios.get(`device/video/size`).then(({ data }) => {\n        return data;\n    }).catch(defaultError);\n}\n\n\nexport async function makeMedia(driver_id) {\n    return await axios.post(`device/media`, {\n        driver_id,\n    }).then(({data}) => {\n        return data;\n    }).catch(defaultError);\n}\n\nexport async function stopMedia(driver_id) {\n    return await axios.post(`device/media/stop`, {\n        driver_id,\n    }).then(async ({data}) => {\n        store.state.temp.photo = store.state.inspection.photo;\n        store.state.temp.video = store.state.inspection.video;\n        await startWaitTimerRecordMedia()\n        return data;\n    }).catch(defaultError);\n}\n\nexport async function makeVideoTest() {\n    return await axios.post(`device/video/test`).then(({ data }) => {\n        return data;\n    }).catch(defaultError);\n}","import alertPath from \"@/assets/audio/alert.ogg\";\nimport store from \"@/store\";\n\nexport function playAlert() {\n    (new Audio(alertPath)).play();\n}\n\nexport async function startWaitTimerRecordMedia() {\n    await stopWaitTimerRecordMedia();\n    let seconds = 5;\n    store.state.waitRecordMedia = true\n\n    store.state.timerRecordMedia = setInterval(() => {\n        seconds--;\n        console.log('осталось ' + seconds)\n        if (seconds < 1) {\n            stopWaitTimerRecordMedia()\n        }\n    }, 1000);\n}\n\nexport async function stopWaitTimerRecordMedia() {\n    if (store.state.waitRecordMedia) {\n        store.state.waitRecordMedia = false\n        await clearInterval(store.state.timerRecordMedia);\n    }\n\n}","<script>\nimport {\n  closeAlcometer, closeAlcometrSocket,\n  enableModeFromSystemConfig,\n  enableSlowModeAlcometer,\n  getAlcometerResult\n} from '@/helpers/alcometer';\nimport {makeMedia, stopMedia} from '@/helpers/camera';\nimport {getSettings} from \"@/helpers/settings\";\nimport {closeDriverPhoto} from \"@/helpers/api/api\";\n\nexport default {\n  data() {\n    return {\n      interval: null,\n      seconds: 5,\n      needRetry: false,\n      showRetry: false,\n      statusAlcometer: \"\",\n      statusPrev: \"prew\",\n      statusNow: \"now\",\n      recording: false\n    }\n  },\n  watch:  {\n    statusNow: async function () {\n      if (this.isChangeStatus(\"WAIT\")) {\n        await this.runWebCam()\n\n      }\n      if ((this.isChangeStatus(\"RESULT\") || this.isChangeStatus(\"ERROR\") || this.isChangeStatus(\"FREE\") || this.isChangeStatus(\"STOP\")) && this.recording) {\n        await this.stopWebCam()\n      }\n    }\n  },\n  methods: {\n    isChangeStatus(status) {\n       return (this.statusNow === status && this.statusPrev !== status)\n    },\n    connect() {\n      this.connection = new WebSocket(\"ws://localhost:8080/device/alcometer/status\")\n      this.connection.onmessage = async (event) => {\n        this.statusPrev = this.statusNow;\n        this.statusNow = event.data;\n      }\n\n      this.connection.onopen = (event) => {\n        console.log(\"Successfully connected to the echo websocket server...\")\n      }\n\n      this.connection.error = (error) => {\n        console.log(error);\n      }\n    },\n    async disconnect() {\n      console.log('Disconnect websoket server');\n      await closeAlcometrSocket();\n    },\n\n\n    async runWebCam() {\n      if (!this.recording) {\n        this.recording = true;\n        const data = await makeMedia(this.$store.state.inspection.driver_id);\n        this.inspection.photo = data?.photo;\n        this.inspection.video = data?.video;\n        console.log(\"start media\")\n      }\n    },\n    async stopWebCam() {\n      if (this.recording) {\n        this.recording = false;\n        await stopMedia(this.$store.state.inspection.driver_id);\n        console.log(\"stop media\")\n      }\n    },\n    nextStep() {\n      this.$router.push({name: 'step-sleep'});\n    },\n    async prevStep() {\n      this.$router.push({name: 'step-thermometer'});\n    },\n    async retry() {\n      this.needRetry = true;\n      setTimeout(() => {\n        this.showRetry = true;\n      }, 3000);\n      await enableSlowModeAlcometer();\n      await closeAlcometer();\n      this.runCountdown();\n    },\n    hasResult(result) {\n      return !(result === undefined || result === null || result === 'next');\n\n    },\n    hasError(result) {\n      return result === \"error\";\n    },\n    checkRetry(result) {\n      return getSettings('alcometer_fast') && getSettings('alcometer_retry') && Number(result) > 0 && !this.needRetry;\n    },\n    runCountdown() {\n      this.seconds = 5;\n      this.timerInterval = setInterval(() => {\n        this.seconds--;\n        if (this.seconds < 1) {\n          clearInterval(this.timerInterval);\n        }\n      }, 1000);\n    },\n  },\n  async mounted() {\n    this.connect()\n    // await this.runWebCam();\n    this.runCountdown()\n\n    this.requestInterval = setInterval(async () => {\n      const result = await getAlcometerResult();\n\n      if (!this.hasResult(result)) {\n        return;\n      }\n\n      if (this.checkRetry(result)) {\n        this.inspection.alcometer_result = result;\n        await this.retry();\n        return;\n      }\n      this.inspection.alcometer_result = Number(result) || 0;\n      this.inspection.alcometer_mode = getSettings('alcometer_fast') ? '0' : '1';\n      this.nextStep();\n    }, 700);\n  },\n  unmounted() {\n    if (this.recording) {\n      this.stopWebCam();\n    }\n    this.disconnect()\n    enableModeFromSystemConfig(getSettings('alcometer_fast'));\n    clearInterval(this.requestInterval);\n    clearInterval(this.timerInterval);\n  },\n  computed: {\n    inspection() {\n      return this.$store.state.inspection;\n    },\n    system() {\n      return this.$store.state.config?.system || {};\n    },\n    status() {\n      if (this.seconds === 5) {\n        return 'через ' + this.seconds + ' секунд';\n      } else if (this.seconds === 1) {\n        return 'через ' + this.seconds + ' секунду';\n      } else if (this.seconds < 1) {\n        return ' прямо сейчас!';\n      } else {\n        return 'через ' + this.seconds + ' секунды';\n      }\n    }\n  },\n}\n</script>\n<template>\n  <div class=\"step-alcometer__outer\">\n\n    <div v-if=\"!showRetry\" class=\"step-alcometer\">\n      <h3 class=\"animate__animated animate__fadeInDown\">Проверка на алкоголь</h3>\n\n      <div  class=\"step-alcometer__items\">\n        <div class=\"step-alcometer__item animate__animated animate__fadeInUp d-1\">\n          <span>1</span>\n          <img style=\"padding-right: 20px\" width=\"55\" src=\"@/assets/images/fast.png\">\n          <label>Проверьте, что вставлена воронка</label>\n        </div>\n        <div class=\"step-alcometer__item animate__animated animate__fadeInUp d-2\">\n          <span>2</span>\n          <img width=\"100\" src=\"@/assets/images/alco_guide_2.png\">\n          Держите алкотестер на расстоянии 2-3 см от рта\n        </div>\n        <div class=\"step-alcometer__text  animate__animated animate__fadeInUp d-2\">\n          Дождитесь ГОТОВ на экране алкометра<br><br>\n          Начните дуть с умеренной силой до окончания<br>\n          звукового сигнала.<br><br>\n          <p v-if=\"!needRetry\">Дуйте {{ status }}</p>\n          <p v-if=\"needRetry\" style=\"width: 100%\">Результат: Положительный</p>\n        </div>\n      </div>\n      <p v-if=\"!showRetry\" class=\"alert red\">\n        <i class=\"ri-alarm-warning-fill\"></i>\n        НЕ ПРИКАСАТЬСЯ К АЛКОТЕСТЕРУ ГУБАМИ\n      </p>\n    </div>\n    <div v-if=\"showRetry\" class=\"step-alcometer\">\n      <h3  class=\"animate__animated animate__fadeInDown\">Количественное определение алкоголя</h3>\n      <div  class=\"step-alcometer__items\">\n        <div class=\"step-alcometer__item animate__animated animate__fadeInUp d-1\">\n          <span style=\"min-height: 30px\">3</span>\n          <img style=\"padding-right: 20px\" width=\"80\" src=\"@/assets/images/precise.png\">\n          Снимите воронку , установите мундштук\n        </div>\n        <div class=\"step-alcometer__text  animate__animated animate__fadeInUp d-2\">\n          Снимите мундштук-воронка<br><br>\n          Установите индивидуальный мундштук<br><br>\n          Дождитесь ГОТОВ на экране алкометра<br><br>\n          Начните дуть с умеренной силой до<br>\n          окончания звукового сигнала.<br><br>\n          Снимите индивидуальный мундштук<br><br>\n          Установите мундштук-воронка<br><br>\n        </div>\n      </div>\n    </div>\n    <div class=\"step-buttons\">\n      <button @click=\"prevStep()\" class=\"btn opacity blue\">Назад</button>\n      <button @click=\"nextStep()\" v-if=\"JSON.parse(system.alcometer_skip)\" class=\"btn\">Продолжить</button>\n    </div>\n  </div>\n</template>\n","import { render } from \"./Step-alcometer.vue?vue&type=template&id=56b37270\"\nimport script from \"./Step-alcometer.vue?vue&type=script&lang=js\"\nexport * from \"./Step-alcometer.vue?vue&type=script&lang=js\"\n\nimport exportComponent from \"/Users/baarme/develop/java/sdpo-java/src/main/frontend/node_modules/vue-loader/dist/exportHelper.js\"\nconst __exports__ = /*#__PURE__*/exportComponent(script, [['render',render]])\n\nexport default __exports__"],"names":["async","makePhoto","axios","post","then","data","catch","defaultError","getSizes","get","makeMedia","driver_id","stopMedia","store","startWaitTimerRecordMedia","makeVideoTest","playAlert","Audio","alertPath","play","stopWaitTimerRecordMedia","seconds","setInterval","console","log","clearInterval","class","_createElementVNode","style","width","src","_imports_0","_imports_1","_hoisted_18","_createElementBlock","_hoisted_1","$data","showRetry","_hoisted_2","_hoisted_3","_hoisted_4","_hoisted_5","_hoisted_6","_hoisted_7","_hoisted_8","_hoisted_9","_hoisted_10","_hoisted_11","_hoisted_12","needRetry","_hoisted_13","_toDisplayString","$options","status","_hoisted_14","_hoisted_15","_hoisted_16","_hoisted_17","_hoisted_20","_hoisted_21","onClick","_cache","$event","prevStep","JSON","parse","system","alcometer_skip","nextStep","interval","statusAlcometer","statusPrev","statusNow","recording","watch","this","isChangeStatus","runWebCam","stopWebCam","methods","connect","connection","WebSocket","onmessage","event","onopen","error","closeAlcometrSocket","$store","state","inspection","photo","video","$router","push","name","setTimeout","enableSlowModeAlcometer","closeAlcometer","runCountdown","hasResult","result","undefined","hasError","checkRetry","getSettings","Number","timerInterval","requestInterval","getAlcometerResult","alcometer_result","retry","alcometer_mode","unmounted","disconnect","enableModeFromSystemConfig","computed","config","__exports__","render"],"sourceRoot":""}